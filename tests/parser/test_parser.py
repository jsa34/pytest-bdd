from pathlib import Path
from pprint import pprint

from src.pytest_bdd.parser import (
    Background,
    Cell,
    Child,
    Comment,
    DataTable,
    DocString,
    Feature,
    GherkinDocument,
    Location,
    Row,
    Rule,
    Scenario,
    Step,
    Tag,
    get_gherkin_document,
)


def test_parser():
    test_dir = Path(__file__).parent
    feature_file = test_dir / "test.feature"
    feature_file_path = str(feature_file.resolve())

    # Call the function to parse the Gherkin document
    gherkin_doc = get_gherkin_document(feature_file_path, str(feature_file))

    # # Define the expected structure
    # expected_document = GherkinDocument(feature=Feature(keyword='Feature', location=Location(column=1, line=2), tags=set(), name='User login', description='As a registered user\nI want to be able to log in\nSo that I can access my account', children=[Child(background=Background(id='1', keyword='Background', location=Location(column=3, line=8), name='', description='', steps=[Step(id='0', keyword='Given', keywordType='Context', location=Location(column=5, line=10), text='the login page is open', name='the login page is open', raw_name='the login page is open', dataTable=None, docString=None, parent=..., failed=False, duration=None)], parent=...), rule=None, scenario=None, parent=...), Child(background=None, rule=None, scenario=Scenario(id='6', keyword='Scenario', location=Location(column=3, line=13), name='Successful login with valid credentials', description='', steps=[Step(id='2', keyword='Given', keywordType='Context', location=Location(column=5, line=14), text='the user enters a valid username', name='the user enters a valid username', raw_name='the user enters a valid username', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='3', keyword='And', keywordType='Conjunction', location=Location(column=5, line=15), text='the user enters a valid password', name='the user enters a valid password', raw_name='the user enters a valid password', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='4', keyword='When', keywordType='Action', location=Location(column=5, line=16), text='the user clicks the login button', name='the user clicks the login button', raw_name='the user clicks the login button', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='5', keyword='Then', keywordType='Outcome', location=Location(column=5, line=17), text='the user should see the dashboard', name='the user should see the dashboard', raw_name='the user should see the dashboard', dataTable=None, docString=None, parent=..., failed=False, duration=None)], tags=set(), examples=[], parent=...), parent=...), Child(background=None, rule=None, scenario=Scenario(id='15', keyword='Scenario Outline', location=Location(column=3, line=19), name='Unsuccessful login with invalid credentials', description='', steps=[Step(id='7', keyword='Given', keywordType='Context', location=Location(column=5, line=20), text='the user enters "<username>" as username', name='the user enters "<username>" as username', raw_name='the user enters "<username>" as username', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='8', keyword='And', keywordType='Conjunction', location=Location(column=5, line=21), text='the user enters "<password>" as password', name='the user enters "<password>" as password', raw_name='the user enters "<password>" as password', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='9', keyword='When', keywordType='Action', location=Location(column=5, line=22), text='the user clicks the login button', name='the user clicks the login button', raw_name='the user clicks the login button', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='10', keyword='Then', keywordType='Outcome', location=Location(column=5, line=23), text='the user should see an error message "<error_message>"', name='the user should see an error message "<error_message>"', raw_name='the user should see an error message "<error_message>"', dataTable=None, docString=None, parent=..., failed=False, duration=None)], tags=set(), examples=[DataTable(location=Location(column=5, line=26), name='', tableHeader=Row(id='11', location=Location(column=7, line=27), cells=[Cell(location=Location(column=9, line=27), value='username'), Cell(location=Location(column=23, line=27), value='password'), Cell(location=Location(column=35, line=27), value='error_message')]), tableBody=[Row(id='12', location=Location(column=7, line=28), cells=[Cell(location=Location(column=9, line=28), value='invalidUser'), Cell(location=Location(column=23, line=28), value='wrongPass'), Cell(location=Location(column=35, line=28), value='Invalid username or password')]), Row(id='13', location=Location(column=7, line=29), cells=[Cell(location=Location(column=9, line=29), value='user123'), Cell(location=Location(column=23, line=29), value='incorrect'), Cell(location=Location(column=35, line=29), value='Invalid username or password')])])], parent=...), parent=...), Child(background=None, rule=None, scenario=Scenario(id='20', keyword='Scenario', location=Location(column=3, line=31), name='Login with empty username', description='', steps=[Step(id='16', keyword='Given', keywordType='Context', location=Location(column=5, line=32), text='the user enters an empty username', name='the user enters an empty username', raw_name='the user enters an empty username', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='17', keyword='And', keywordType='Conjunction', location=Location(column=5, line=33), text='the user enters a valid password', name='the user enters a valid password', raw_name='the user enters a valid password', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='18', keyword='When', keywordType='Action', location=Location(column=5, line=34), text='the user clicks the login button', name='the user clicks the login button', raw_name='the user clicks the login button', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='19', keyword='Then', keywordType='Outcome', location=Location(column=5, line=35), text='the user should see an error message "Username cannot be empty"', name='the user should see an error message "Username cannot be empty"', raw_name='the user should see an error message "Username cannot be empty"', dataTable=None, docString=None, parent=..., failed=False, duration=None)], tags=set(), examples=[], parent=...), parent=...), Child(background=None, rule=None, scenario=Scenario(id='25', keyword='Scenario', location=Location(column=3, line=37), name='Login with empty password', description='', steps=[Step(id='21', keyword='Given', keywordType='Context', location=Location(column=5, line=38), text='the user enters a valid username', name='the user enters a valid username', raw_name='the user enters a valid username', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='22', keyword='And', keywordType='Conjunction', location=Location(column=5, line=39), text='the user enters an empty password', name='the user enters an empty password', raw_name='the user enters an empty password', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='23', keyword='When', keywordType='Action', location=Location(column=5, line=40), text='the user clicks the login button', name='the user clicks the login button', raw_name='the user clicks the login button', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='24', keyword='Then', keywordType='Outcome', location=Location(column=5, line=41), text='the user should see an error message "Password cannot be empty"', name='the user should see an error message "Password cannot be empty"', raw_name='the user should see an error message "Password cannot be empty"', dataTable=None, docString=None, parent=..., failed=False, duration=None)], tags=set(), examples=[], parent=...), parent=...), Child(background=None, rule=None, scenario=Scenario(id='30', keyword='Scenario', location=Location(column=3, line=43), name='Login with SQL injection attempt', description='', steps=[Step(id='26', keyword='Given', keywordType='Context', location=Location(column=5, line=44), text='the user enters "admin\' OR \'1\'=\'1" as username', name='the user enters "admin\' OR \'1\'=\'1" as username', raw_name='the user enters "admin\' OR \'1\'=\'1" as username', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='27', keyword='And', keywordType='Conjunction', location=Location(column=5, line=45), text='the user enters "password" as password', name='the user enters "password" as password', raw_name='the user enters "password" as password', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='28', keyword='When', keywordType='Action', location=Location(column=5, line=46), text='the user clicks the login button', name='the user clicks the login button', raw_name='the user clicks the login button', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='29', keyword='Then', keywordType='Outcome', location=Location(column=5, line=47), text='the user should see an error message "Invalid username or password"', name='the user should see an error message "Invalid username or password"', raw_name='the user should see an error message "Invalid username or password"', dataTable=None, docString=None, parent=..., failed=False, duration=None)], tags=set(), examples=[], parent=...), parent=...), Child(background=None, rule=None, scenario=Scenario(id='35', keyword='Scenario', location=Location(column=3, line=50), name='Login button disabled for empty fields', description='', steps=[Step(id='31', keyword='Given', keywordType='Context', location=Location(column=5, line=51), text='the user has not entered any username or password', name='the user has not entered any username or password', raw_name='the user has not entered any username or password', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='32', keyword='Then', keywordType='Outcome', location=Location(column=5, line=52), text='the login button should be disabled', name='the login button should be disabled', raw_name='the login button should be disabled', dataTable=None, docString=None, parent=..., failed=False, duration=None)], tags={Tag(id='33', location=Location(column=3, line=49), name='@login'), Tag(id='34', location=Location(column=10, line=49), name='@critical')}, examples=[], parent=...), parent=...), Child(background=None, rule=None, scenario=Scenario(id='39', keyword='Scenario', location=Location(column=3, line=56), name='Login page loads correctly', description='', steps=[Step(id='36', keyword='Given', keywordType='Context', location=Location(column=5, line=57), text='the login page is loaded', name='the login page is loaded', raw_name='the login page is loaded', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='37', keyword='Then', keywordType='Outcome', location=Location(column=5, line=58), text='the login form should be visible', name='the login form should be visible', raw_name='the login form should be visible', dataTable=None, docString=None, parent=..., failed=False, duration=None)], tags={Tag(id='38', location=Location(column=3, line=55), name='@smoke')}, examples=[], parent=...), parent=...), Child(background=None, rule=None, scenario=Scenario(id='53', keyword='Scenario', location=Location(column=3, line=61), name='Login with multiple sets of credentials', description='', steps=[Step(id='44', keyword='Given', keywordType='Context', location=Location(column=5, line=62), text='the following users are registered:', name='the following users are registered:', raw_name='the following users are registered:', dataTable=DataTable(location=Location(column=7, line=63), name=None, tableHeader=None, tableBody=[]), docString=None, parent=..., failed=False, duration=None), Step(id='48', keyword='When', keywordType='Action', location=Location(column=5, line=67), text='the user tries to log in with the following credentials:', name='the user tries to log in with the following credentials:', raw_name='the user tries to log in with the following credentials:', dataTable=DataTable(location=Location(column=7, line=68), name=None, tableHeader=None, tableBody=[]), docString=None, parent=..., failed=False, duration=None), Step(id='52', keyword='Then', keywordType='Outcome', location=Location(column=5, line=71), text='the login attempts should result in:', name='the login attempts should result in:', raw_name='the login attempts should result in:', dataTable=DataTable(location=Location(column=7, line=72), name=None, tableHeader=None, tableBody=[]), docString=None, parent=..., failed=False, duration=None)], tags=set(), examples=[], parent=...), parent=...), Child(background=None, rule=None, scenario=Scenario(id='57', keyword='Scenario', location=Location(column=3, line=77), name='Check login error message with detailed explanation', description='', steps=[Step(id='54', keyword='Given', keywordType='Context', location=Location(column=5, line=78), text='the user enters invalid credentials', name='the user enters invalid credentials', raw_name='the user enters invalid credentials', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='55', keyword='When', keywordType='Action', location=Location(column=5, line=79), text='the user clicks the login button', name='the user clicks the login button', raw_name='the user clicks the login button', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='56', keyword='Then', keywordType='Outcome', location=Location(column=5, line=80), text='the user should see the following error message:', name='the user should see the following error message:\nYour login attempt was unsuccessful.\nPlease check your username and password and try again.\nIf the problem persists, contact support.', raw_name='the user should see the following error message:\nYour login attempt was unsuccessful.\nPlease check your username and password and try again.\nIf the problem persists, contact support.', dataTable=None, docString=DocString(content='Your login attempt was unsuccessful.\nPlease check your username and password and try again.\nIf the problem persists, contact support.', delimiter='"""', location=Location(column=7, line=81)), parent=..., failed=False, duration=None)], tags=set(), examples=[], parent=...), parent=...), Child(background=None, rule=Rule(id='64', keyword='Rule', location=Location(column=3, line=88), name='a sale cannot happen if there is no stock', description='', tags={Tag(id='63', location=Location(column=3, line=87), name='@some-tag')}, children=[Child(background=None, rule=None, scenario=Scenario(id='62', keyword='Example', location=Location(column=3, line=90), name='No chocolates left', description='', steps=[Step(id='58', keyword='Given', keywordType='Context', location=Location(column=5, line=91), text='the customer has 100 cents', name='the customer has 100 cents', raw_name='the customer has 100 cents', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='59', keyword='And', keywordType='Conjunction', location=Location(column=5, line=92), text='there are no chocolate bars in stock', name='there are no chocolate bars in stock', raw_name='there are no chocolate bars in stock', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='60', keyword='When', keywordType='Action', location=Location(column=5, line=93), text='the customer tries to buy a 1 cent chocolate bar', name='the customer tries to buy a 1 cent chocolate bar', raw_name='the customer tries to buy a 1 cent chocolate bar', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='61', keyword='Then', keywordType='Outcome', location=Location(column=5, line=94), text='the sale should not happen', name='the sale should not happen', raw_name='the sale should not happen', dataTable=None, docString=None, parent=..., failed=False, duration=None)], tags=set(), examples=[], parent=None), parent=...)], parent=None), scenario=None, parent=...), Child(background=None, rule=Rule(id='75', keyword='Rule', location=Location(column=3, line=96), name='A sale cannot happen if the customer does not have enough money', description='', tags=set(), children=[Child(background=None, rule=None, scenario=Scenario(id='69', keyword='Example', location=Location(column=5, line=98), name='Not enough money', description='', steps=[Step(id='65', keyword='Given', keywordType='Context', location=Location(column=7, line=99), text='the customer has 100 cents', name='the customer has 100 cents', raw_name='the customer has 100 cents', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='66', keyword='And', keywordType='Conjunction', location=Location(column=7, line=100), text='there are chocolate bars in stock', name='there are chocolate bars in stock', raw_name='there are chocolate bars in stock', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='67', keyword='When', keywordType='Action', location=Location(column=7, line=101), text='the customer tries to buy a 125 cent chocolate bar', name='the customer tries to buy a 125 cent chocolate bar', raw_name='the customer tries to buy a 125 cent chocolate bar', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='68', keyword='Then', keywordType='Outcome', location=Location(column=7, line=102), text='the sale should not happen', name='the sale should not happen', raw_name='the sale should not happen', dataTable=None, docString=None, parent=..., failed=False, duration=None)], tags=set(), examples=[], parent=None), parent=...), Child(background=None, rule=None, scenario=Scenario(id='74', keyword='Example', location=Location(column=5, line=105), name='Enough money', description='', steps=[Step(id='70', keyword='Given', keywordType='Context', location=Location(column=7, line=106), text='the customer has 100 cents', name='the customer has 100 cents', raw_name='the customer has 100 cents', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='71', keyword='And', keywordType='Conjunction', location=Location(column=7, line=107), text='there are chocolate bars in stock', name='there are chocolate bars in stock', raw_name='there are chocolate bars in stock', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='72', keyword='When', keywordType='Action', location=Location(column=7, line=108), text='the customer tries to buy a 75 cent chocolate bar', name='the customer tries to buy a 75 cent chocolate bar', raw_name='the customer tries to buy a 75 cent chocolate bar', dataTable=None, docString=None, parent=..., failed=False, duration=None), Step(id='73', keyword='Then', keywordType='Outcome', location=Location(column=7, line=109), text='the sale should happen', name='the sale should happen', raw_name='the sale should happen', dataTable=None, docString=None, parent=..., failed=False, duration=None)], tags=set(), examples=[], parent=None), parent=...)], parent=None), scenario=None, parent=...)], abs_filename='/Users/jsa34/PycharmProjects/pytest-bdd/tests/parser/test.feature', rel_filename='/Users/jsa34/PycharmProjects/pytest-bdd/tests/parser/test.feature'), comments=[Comment(location=Location(column=1, line=1), text='# This is a comment'), Comment(location=Location(column=1, line=9), text='    # Background steps run before each scenario'), Comment(location=Location(column=1, line=12), text='    # Scenario within the rule'), Comment(location=Location(column=1, line=25), text='      # Examples table provides data for the scenario outline'), Comment(location=Location(column=1, line=54), text='  # Tags can be used to categorize scenarios'), Comment(location=Location(column=1, line=60), text='  # Using Data Tables for more complex data'), Comment(location=Location(column=1, line=76), text='  # Using Doc Strings for multi-line text'), Comment(location=Location(column=1, line=89), text='  # Unhappy path'), Comment(location=Location(column=1, line=97), text='    # Unhappy path'), Comment(location=Location(column=1, line=104), text='    # Happy path')]) != 'expected_document'
    pprint(gherkin_doc)
    assert gherkin_doc == "expected_document"
